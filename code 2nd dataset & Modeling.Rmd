---
title: "2nd dataset"
author: "Jingyu Liang"
date: "2024-10-14"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(ggplot2)
library(gridExtra)
library(writexl)
library(tableone)
library(kableExtra)
library(table1)
library(pacman)
library(MASS)
p_load(
  tidyverse, flextable, gtsummary, labelled, officer
)
library(gtsummary)
library(webshot2)
library(magrittr)
library(car)
library(mediation)
library(survey)
library(car)
library(pscl)
library(glmnet)
library(sandwich)
library(lmtest)
library(logistf) 
library(elrm) # exact logistic regression
```

# datasets
## cl_data & quest & mental
```{r}
# original questionnaire dataset
quest <- read_excel("FF questionnaire 1211 - added cutoff_for_code.xlsx", sheet= "data_entry_adj")
quest <- as.data.frame(quest)
colnames(quest)[1] <- "FFID"

# dataset for demographic table
cl_data <- read.csv("datafordemographictable.csv")
cl_data <- as.data.frame(cl_data)
cl_data <- cl_data %>%
  mutate(
    BMI_levels = as.character(BMI_levels),
    CESD_bi = as.character(CESD_bi),
    PCL_bi = as.character(PCL_bi),
    ASI_p = as.integer(ASI_p),
    ASI_c = as.integer(ASI_c),
    Total = "Overall"
  ) 

# mental health data for model
mental <- read_excel("data_questionformodel.xlsx", sheet = "data_adj2")[,1:12]
```



# demographic table
## [sample] Table for Traumatic Events on Duty
```{r}
# traumaticeventsonduty ####
# Step 1: 生成带缩进信息的 gtsummary 表
# traumatic_events_table <- cl_data %>%
#   select(Traumatic.events.on.duty:Vehicle.Accidents) %>%  # Select Traumatic Events
#   tbl_summary(
#     by = NULL,
#     label = list(
#       Traumatic.events.on.duty ~ "Traumatic Events on Duty (multiple choice), n (%)",
#       Fire.related.incidents ~ "Fire Related Incidents",
#       Natural.disasters ~ "Natural Disasters",
#       Sudden.death.or.loss.of.a.peer.firefighters ~ "Sudden Death or Loss of a Peer Firefighter",
#       Serious.accidents.or.injuries ~ "Serious Accidents or Injuries",
#       Serious.illness.or.medical.procedures ~ "Serious Illness or Medical Procedures",
#       Covid ~ "Covid",
#       Vehicle.Accidents ~ "Vehicle Accidents"
#     ),
#     statistic = all_categorical() ~ "{n} ({p}%)",
#     missing = "no"
#   ) %>%
#   modify_table_body(
#     ~ .x %>%
#       mutate(indent = ifelse(variable == "Traumatic.events.on.duty", 0, 1))  # Add indentation column
#   )
# 
# # Step 2: 将 gtsummary 表转为 flextable
# traumatic_events_flextable <- traumatic_events_table %>%
#   as_flex_table() %>%
#   flextable::autofit()
# 
# # Step 3: 手动应用缩进
# traumatic_events_flextable <- traumatic_events_flextable %>%
#   flextable::padding(
#     i = which(traumatic_events_table$table_body$indent == 1),  # 找到需要缩进的行
#     padding.left = 20,  # 设置左侧缩进
#     part = "body"
#   )
# 
# # Step 4: 让 "Traumatic Events on Duty" 行加粗
# traumatic_events_flextable <- traumatic_events_flextable %>%
#   flextable::bold(
#     i =  which(traumatic_events_table$table_body$variable == "Traumatic.events.on.duty"),  # 确定加粗的行
#     part = "body"
#   )
```


## 1. Table for all multiple choices questions
add mental health measurements 
```{r}
# add CESD mean ####

# Initialize an empty list to store intermediate data frames
cesd_single_option_tables <- list()

# Loop through columns 17 to 37
for (col in 17:37) {
  # Replace 0 with NA in the current column
  cl_data[[col]][cl_data[[col]] == 0] <- NA
  
  # Generate the summary table for the current column
  cesd_single_option <- cl_data %>%
    group_by(cl_data[[col]]) %>%
    summarise(CESD_mean = round(mean(CESD, na.rm = TRUE), 2)) %>%
    rename(characteristic = `cl_data[[col]]`) %>%
    mutate(variable = colnames(cl_data)[col])  # Add a column to identify the variable
  
  # Append to the list
  cesd_single_option_tables[[col]] <- cesd_single_option
}

# Combine all individual tables into one big data frame
cesd_multichoice <- bind_rows(cesd_single_option_tables)
cesd_multichoice <- na.omit(cesd_multichoice)[,-1]

# # Extract the table body from the gtsummary table
# table_body <- multichoicequest_table$table_body
# 
# # Merge CESD_mean data into the demographic table body based on the variable names
# table_body <- table_body %>%
#   left_join(
#     cesd_multichoice %>% rename(variable = variable),  # Ensure column name consistency
#     by = "variable"
#   )
# 
# # Add CESD_mean column to the gtsummary table
# multichoicequest_table_updated <- multichoicequest_table %>%
#   modify_table_body(~ table_body) %>%
#   modify_header(
#     update = list(CESD_mean = "**CES-D-m (Mean)**")  # Add CESD_mean to the header
#   )

# add ASI mean ####

# Initialize an empty list to store intermediate data frames
asi_single_option_tables <- list()

# Loop through columns 17 to 37
for (col in 17:37) {
  
  # Generate the summary table for the current column
  asi_single_option <- cl_data %>%
    group_by(cl_data[[col]]) %>%
    summarise(ASI_mean = round(mean(ASI, na.rm = TRUE), 2)) %>%
    rename(characteristic = `cl_data[[col]]`) %>%
    mutate(variable = colnames(cl_data)[col])  # Add a column to identify the variable
  
  # Append to the list
  asi_single_option_tables[[col]] <- asi_single_option
}

# Combine all individual tables into one big data frame
asi_multichoice <- bind_rows(asi_single_option_tables)
asi_multichoice <- na.omit(asi_multichoice)[,-1]

# add ASI_p mean ####

# Initialize an empty list to store intermediate data frames
asi_p_single_option_tables <- list()

# Loop through columns 17 to 37
for (col in 17:37) {
  
  # Generate the summary table for the current column
  asi_p_single_option <- cl_data %>%
    group_by(cl_data[[col]]) %>%
    summarise(ASI_p_mean = round(mean(ASI_p, na.rm = TRUE), 2)) %>%
    rename(characteristic = `cl_data[[col]]`) %>%
    mutate(variable = colnames(cl_data)[col])  # Add a column to identify the variable
  
  # Append to the list
  asi_p_single_option_tables[[col]] <- asi_p_single_option
}

# Combine all individual tables into one big data frame
asi_p_multichoice <- bind_rows(asi_p_single_option_tables)
asi_p_multichoice <- na.omit(asi_p_multichoice)[,-1]

# add ASI_c mean ####

# Initialize an empty list to store intermediate data frames
asi_c_single_option_tables <- list()

# Loop through columns 17 to 37
for (col in 17:37) {
  
  # Generate the summary table for the current column
  asi_c_single_option <- cl_data %>%
    group_by(cl_data[[col]]) %>%
    summarise(ASI_c_mean = round(mean(ASI_c, na.rm = TRUE), 2)) %>%
    rename(characteristic = `cl_data[[col]]`) %>%
    mutate(variable = colnames(cl_data)[col])  # Add a column to identify the variable
  
  # Append to the list
  asi_c_single_option_tables[[col]] <- asi_c_single_option
}

# Combine all individual tables into one big data frame
asi_c_multichoice <- bind_rows(asi_c_single_option_tables)
asi_c_multichoice <- na.omit(asi_c_multichoice)[,-1]

# add ASI_s mean ####

# Initialize an empty list to store intermediate data frames
asi_s_single_option_tables <- list()

# Loop through columns 17 to 37
for (col in 17:37) {
  
  # Generate the summary table for the current column
  asi_s_single_option <- cl_data %>%
    group_by(cl_data[[col]]) %>%
    summarise(ASI_s_mean = round(mean(ASI_s, na.rm = TRUE), 2)) %>%
    rename(characteristic = `cl_data[[col]]`) %>%
    mutate(variable = colnames(cl_data)[col])  # Add a column to identify the variable
  
  # Append to the list
  asi_s_single_option_tables[[col]] <- asi_s_single_option
}

# Combine all individual tables into one big data frame
asi_s_multichoice <- bind_rows(asi_s_single_option_tables)
asi_s_multichoice <- na.omit(asi_s_multichoice)[,-1]

# add FAST mean ####

# Initialize an empty list to store intermediate data frames
fast_single_option_tables <- list()

# Loop through columns 17 to 37
for (col in 17:37) {
  
  # Generate the summary table for the current column
  fast_single_option <- cl_data %>%
    group_by(cl_data[[col]]) %>%
    summarise(FAST_mean = round(mean(FAST, na.rm = TRUE), 2)) %>%
    rename(characteristic = `cl_data[[col]]`) %>%
    mutate(variable = colnames(cl_data)[col])  # Add a column to identify the variable
  
  # Append to the list
  fast_single_option_tables[[col]] <- fast_single_option
}

# Combine all individual tables into one big data frame
fast_multichoice <- bind_rows(fast_single_option_tables)
fast_multichoice <- na.omit(fast_multichoice)[,-1]


# add PCL mean ####

# Initialize an empty list to store intermediate data frames
pcl_single_option_tables <- list()

# Loop through columns 17 to 37
for (col in 17:37){
  
  # Generate the summary table for the current column
  pcl_single_option <- cl_data %>%
    group_by(cl_data[[col]]) %>%
    summarise(PCL_mean = round(mean(PCL, na.rm = TRUE), 2)) %>%
    rename(characteristic = `cl_data[[col]]`) %>%
    mutate(variable = colnames(cl_data)[col])  # Add a column to identify the variable
  
  # Append to the list
  pcl_single_option_tables[[col]] <- pcl_single_option
}

# Combine all individual tables into one big data frame
pcl_multichoice <- bind_rows(pcl_single_option_tables)
pcl_multichoice <- na.omit(pcl_multichoice)[,-1]
```
merge all mental health mean values
```{r}
allmental_multichoice <- cesd_multichoice %>%
  left_join(asi_multichoice, by = "variable") %>%
  left_join(asi_p_multichoice, by = "variable") %>%
  left_join(asi_c_multichoice, by = "variable") %>%
  left_join(asi_s_multichoice, by = "variable") %>%
  left_join(fast_multichoice, by = "variable") %>%
  left_join(pcl_multichoice, by = "variable")
```
generate gtsummary table
```{r}
# dataset for demographic table
cl_data <- read.csv("datafordemographictable.csv")
cl_data <- as.data.frame(cl_data)
cl_data <- cl_data %>%
  mutate(
    BMI_levels = as.character(BMI_levels),
    CESD_bi = as.character(CESD_bi),
    PCL_bi = as.character(PCL_bi),
    ASI_p = as.integer(ASI_p),
    ASI_c = as.integer(ASI_c),
    Total = "Overall"
  ) 

# gtsummary table
multichoicequest_table <- cl_data %>%
  select(Traumatic.events.on.duty:bipolar) %>%  # Select all questions
  tbl_summary(
    by = NULL,
    label = list(
      Traumatic.events.on.duty ~ "Traumatic Events on Duty (multiple choice), n (%)",
      Fire.related.incidents ~ "Fire Related Incidents",
      Natural.disasters ~ "Natural Disasters",
      Sudden.death.or.loss.of.a.peer.firefighters ~ "Sudden Death or Loss of a Peer Firefighter",
      # Serious.accidents.or.injuries ~ "Serious Accidents or Injuries",
      Serious.illness.or.medical.procedures ~ "Serious Illness or Medical Procedures",
      Covid ~ "Covid",
      Vehicle.Accidents ~ "Vehicle Accidents",
      Traumatic.events.during.childhood ~ "Traumatic Events During Childhood (multiple choice), n (%)",
      Physical.or.emotional.abuse ~ "Physical or Emotional Abuse",
      # Neglect.or.abandonment ~ "Neglect or Abandonment",
      # Witnessing.domestic.violence ~ "Witnessing Domestic Violence",
      Natural.disasters.1 ~ "Natural Disasters",
      Sudden.death.or.loss.of.a.loved.one ~ "Sudden Death or Loss of a Loved One",
      # Serious.accidents.or.injuries.1 ~ "Serious Accidents or Injuries",
      # Forced.displacement.or.migration ~ "Forced Displacement or Migration",
      Serious.illness.or.medical.procedures.1 ~ "Serious Illness or Medical Procedures",
      # Bullying.or.peer.victimization ~ "Bullying or Peer Victimization",
      # Parents.fighting ~ "Parents Fighting",
      Family.history.of.mental.health.issues ~ "Family History of Mental Health Issues (multiple choice), n (%)",
      No ~ "No",
      Unknown ~ "Unknown",
      PTSD ~ "PTSD",
      DEPRESSION ~ "Depression",
      ANXIETY ~ "Anxiety",
      STRESS ~ "Stress",
      DEMENTIA ~ "Dementia",
      Alzheimer.s ~ "Alzheimer's",
      bipolar ~ "Bipolar"
      # types.of.fires ~ "Types of Fires (multiple choice), n (%)",
      # Structural ~ "Structural",
      # Wildfire ~ "Wildfire",
      # Dumpster ~ "Dumpster",
      # Vehicle ~ "Vehicle",
      # Petroleum ~ "Petroleum",
      # Controlled.Burn ~ "Controlled Burn",
      # Fire.training ~ "Fire Training",
      # Commercial.Fire ~ "Commercial Fire",
      # House.Fire ~ "House Fire",
      # Wildland ~ "Wildland",
      # primary.responsibilities.recently ~ "Primary Responsibilities Recently (multiple choice), n (%)",
      # Driver.Engineer ~ "Driver/Engineer",
      # Suppression ~ "Suppression",
      # Search.rescue ~ "Search & Rescue",
      # Loss.control ~ "Loss Control",
      # Investigation ~ "Investigation",
      # Supervising ~ "Supervising",
      # RIT..Rapid.Intervention.Team. ~ "RIT (Rapid Intervention Team)",
      # Instructor ~ "Instructor",
      # At.what.point.do.you.take.off.your.SCBA ~ "At What Point Do You Take Off Your SCBA (multiple choice), n (%)",
      # End.of.Suppression ~ "End of Suppression",
      # End.of.Overhaul ~ "End of Overhaul",
      # Out.of.IDLH ~ "Out of IDLH",
      # End.of.Evolution ~ "End of Evolution",
      # Move.to.N95 ~ "Move to N95",
      # Situational ~ "Situational",
      # Don.t.Use ~ "Don't Use",
      # Filtration.masks.after.removing.SCBA ~ "Filtration Masks After Removing SCBA (multiple choice), n (%)",
      # No.1 ~ "No",
      # Unknown.1 ~ "Unknown",
      # N95 ~ "N95",
      # face.respirator ~ "Face Respirator"

    ),
    statistic = all_categorical() ~ "{n} ({p}%)",
    missing = "no"
  ) 
```
add all mental health data to the gtsummary table 
```{r}
# Extract the table body from the gtsummary table
table_body <- multichoicequest_table$table_body

# Merge asi_mean data into the demographic table body based on the variable names
table_body <- table_body %>%
  left_join(
    allmental_multichoice %>% rename(variable = variable,
                                     `CES-D-m (Mean Score)` = CESD_mean,
                                     `ASI-m (Mean Score)` = ASI_mean,
                                     `ASI-p-m (Mean Score)` = ASI_p_mean,
                                     `ASI-c-m (Mean Score)` = ASI_c_mean,
                                     `ASI-s-m (Mean Score)` = ASI_s_mean,
                                     `FAST-m (Mean Score)` = FAST_mean,
                                     `PCL-m (Mean Score)` = PCL_mean), 
    by = "variable"
  )

# Add asi_mean column to the demographic table
multichoicequest_table <- multichoicequest_table %>%
  modify_table_body(~ table_body) %>%
  modify_header(
    update = list(`ASI-m (Mean Score)` = "**ASI-m (Mean)**",  # Add ASI_mean to the header
                  `ASI-p-m (Mean Score)` = "**ASI-p-m (Mean)**",  # Add ASI_mean to the header
                  `ASI-c-m (Mean Score)` = "**ASI-c-m (Mean)**",  # Add ASI_mean to the header
                  `ASI-s-m (Mean Score)` = "**ASI-s-m (Mean)**",  # Add ASI_mean to the header
                  `CES-D-m (Mean Score)` = "**CES-D-m (Mean)**",  # Add ASI_mean to the header
                  `PCL-m (Mean Score)` = "**PCL-m (Mean)**",  # Add ASI_mean to the header
                  `FAST-m (Mean Score)` = "**FAST-m (Mean)**" # Add ASI_mean to the header  
    )
  )
```
transfer gtsummary to flextable
```{r}
multichoicequest_flextable <- multichoicequest_table %>%
   as_flex_table() %>%
  flextable::autofit()
  
multichoicequest_flextable
```

## 2. Table for single choice questions (basic)

```{r}
# demographic table
demographic_table <- cl_data %>% 
  select(Total, BMI_levels,Sex, Race, Ethnicity, Tobacco.user, Consume.alcohol, 
         # Vigorous.physical.activities.outside.of.work,
         # Moderate.physical.activities.outside.of.work,
         Rank
         # Years.as.a.Firefighter,
         # Years.served.at.current.department,
         # Non.fire.related.activities.per.week,
         # Average.fire.related.activities.per.week,
         # Average.hours.on.fire.scenes.per.week
         ) %>%
  tbl_summary(
    label = list(
      Tobacco.user ~ "Tobacco User",
      Consume.alcohol ~ "Consume Alcohol"
      # Vigorous.physical.activities.outside.of.work ~ "Vigorous Physical Activities Outside of Work",
      # Moderate.physical.activities.outside.of.work ~ "Moderate Physical Activities Outside of Work",
      # Years.as.a.Firefighter ~ "Years as a Firefighter",
      # Years.served.at.current.department ~ "Years Served at Current Department",
      # Non.fire.related.activities.per.week ~ "Non-Fire Related Activities per Week",
      # Average.fire.related.activities.per.week ~ "Average Fire Related Activities per Week",
      # Average.hours.on.fire.scenes.per.week ~ "Average Hours on Fire Scenes per Week"
    ),
    type = all_continuous() ~ "continuous2",
    statistic = list(
      all_continuous() ~ c(
        "{mean} ({sd})",
        "{median}",
        "{min}, {max}"
      ),
      all_categorical() ~ "{n} ({p}%)"
    ),
    digits = all_continuous() ~ 2, 
    missing = "no"
  ) %>%
  bold_labels() %>%
  add_stat_label() %>%
  modify_header(
    label = "",
    all_stat_cols() ~ "**{level}**, N = {n} ({style_percent(p)}%)"
  ) #%>% gtsummary::as_flex_table()
 
# demographic_table %>% 
#    flextable::autofit() %>% 
#    flextable::width(width = 3) %>% 
#    flextable::line_spacing(space = 0.70, part = "body")
```

## 3. Add mental health measurements to (basic) gtsummary table
``` {r}

# add CESD mean ####

cesd_by_BMI <- cl_data %>%
  group_by(BMI_levels) %>%
  summarise(CESD_mean = round(mean(CESD, na.rm = TRUE), 2))%>%
  rename(characteristic = BMI_levels)  # Rename the first column

cesd_by_sex <- cl_data %>%
  group_by(Sex) %>%
  summarise(CESD_mean = round(mean(CESD, na.rm = TRUE), 2))%>%
  rename(characteristic = Sex)  # Rename the first column

cesd_by_race <- cl_data %>%
  group_by(Race) %>%
  summarise(CESD_mean = round(mean(CESD, na.rm = TRUE), 2))%>%
  rename(characteristic = Race)  # Rename the first column

cesd_by_ethnicity <- cl_data %>%
  group_by(Ethnicity) %>%
  summarise(CESD_mean = round(mean(CESD, na.rm = TRUE), 2))%>%
  rename(characteristic = Ethnicity)  # Rename the first column

cesd_by_tobacco <- cl_data %>%
  group_by(Tobacco.user) %>%
  summarise(CESD_mean = round(mean(CESD, na.rm = TRUE), 2))%>%
  rename(characteristic = Tobacco.user) 

cesd_by_Consume.alcohol <- cl_data %>%
  group_by(Consume.alcohol) %>%
  summarise(CESD_mean = round(mean(CESD, na.rm = TRUE), 2))%>%
  rename(characteristic = Consume.alcohol) 

# cesd_by_1 <- cl_data %>%
#   group_by(Vigorous.physical.activities.outside.of.work) %>%
#   summarise(CESD_mean = round(mean(CESD, na.rm = TRUE), 2))%>%
#   rename(characteristic = Vigorous.physical.activities.outside.of.work) 

# cesd_by_2 <- cl_data %>%
#   group_by(Moderate.physical.activities.outside.of.work) %>%
#   summarise(CESD_mean = round(mean(CESD, na.rm = TRUE), 2))%>%
#   rename(characteristic = Moderate.physical.activities.outside.of.work) 

cesd_by_3 <- cl_data %>%
  group_by(Rank) %>%
  summarise(CESD_mean = round(mean(CESD, na.rm = TRUE), 2))%>%
  rename(characteristic = Rank) 

cesd_table <- cl_data %>%
  group_by(Total) %>%
  summarise(CESD_mean = mean(CESD, na.rm = TRUE)) %>%
  rename(characteristic = Total)  # Rename the first column

cesd_1 <- cesd_table %>% mutate(characteristic = NA, CESD_mean = NA)

cesd <- bind_rows(cesd_1, cesd_table,
                  cesd_1, cesd_by_BMI, 
                  cesd_1, cesd_by_sex, 
                  cesd_1, cesd_by_race, 
                  cesd_1, cesd_by_ethnicity,
                  cesd_1, cesd_by_tobacco, 
                  cesd_1, cesd_by_Consume.alcohol,
                  # cesd_1, cesd_by_1, 
                  # cesd_1, cesd_by_2, 
                  cesd_1, cesd_by_3
                  # cesd_1, cesd_1, cesd_1, cesd_1, 
                  # cesd_1, cesd_1, cesd_1, cesd_1, 
                  # cesd_1, cesd_1, cesd_1, cesd_1, 
                  # cesd_1, cesd_1, cesd_1, cesd_1, 
                  # cesd_1, cesd_1, cesd_1, cesd_1
                  )

# add ASI mean ####
ASI_by_BMI <- cl_data %>%
  group_by(BMI_levels) %>%
  summarise(ASI_mean = round(mean(ASI, na.rm = TRUE), 2))%>%
  rename(characteristic = BMI_levels)  # Rename the first column

ASI_by_sex <- cl_data %>%
  group_by(Sex) %>%
  summarise(ASI_mean = round(mean(ASI, na.rm = TRUE), 2))%>%
  rename(characteristic = Sex)  # Rename the first column

ASI_by_race <- cl_data %>%
  group_by(Race) %>%
  summarise(ASI_mean = round(mean(ASI, na.rm = TRUE), 2))%>%
  rename(characteristic = Race)  # Rename the first column

ASI_by_ethnicity <- cl_data %>%
  group_by(Ethnicity) %>%
  summarise(ASI_mean = round(mean(ASI, na.rm = TRUE), 2))%>%
  rename(characteristic = Ethnicity)  # Rename the first column

ASI_by_tobacco <- cl_data %>%
  group_by(Tobacco.user) %>%
  summarise(ASI_mean = round(mean(ASI, na.rm = TRUE), 2))%>%
  rename(characteristic = Tobacco.user) 

ASI_by_Consume.alcohol <- cl_data %>%
  group_by(Consume.alcohol) %>%
  summarise(ASI_mean = round(mean(ASI, na.rm = TRUE), 2))%>%
  rename(characteristic = Consume.alcohol) 

# ASI_by_1 <- cl_data %>%
#   group_by(Vigorous.physical.activities.outside.of.work) %>%
#   summarise(ASI_mean = round(mean(ASI, na.rm = TRUE), 2))%>%
#   rename(characteristic = Vigorous.physical.activities.outside.of.work) 
# 
# ASI_by_2 <- cl_data %>%
#   group_by(Moderate.physical.activities.outside.of.work) %>%
#   summarise(ASI_mean = round(mean(ASI, na.rm = TRUE), 2))%>%
#   rename(characteristic = Moderate.physical.activities.outside.of.work) 

ASI_by_3 <- cl_data %>%
  group_by(Rank) %>%
  summarise(ASI_mean = round(mean(ASI, na.rm = TRUE), 2))%>%
  rename(characteristic = Rank) 

ASI_table <- cl_data %>%
  group_by(Total) %>%
  summarise(ASI_mean = mean(ASI, na.rm = TRUE)) %>%
  rename(characteristic = Total)  # Rename the first column

ASI_1 <- ASI_table %>% mutate(characteristic = NA, ASI_mean = NA)

ASI <- bind_rows(ASI_1,ASI_table,
                 ASI_1, ASI_by_BMI, 
                  ASI_1, ASI_by_sex, 
                  ASI_1, ASI_by_race, 
                  ASI_1, ASI_by_ethnicity,
                  ASI_1, ASI_by_tobacco, 
                  ASI_1, ASI_by_Consume.alcohol,
                  # ASI_1, ASI_by_1, 
                  # ASI_1, ASI_by_2, 
                  ASI_1, ASI_by_3
                  # ASI_1, ASI_1, ASI_1, ASI_1, 
                  # ASI_1, ASI_1, ASI_1, ASI_1, ASI_1, ASI_1, ASI_1, ASI_1, 
                  # ASI_1, ASI_1, ASI_1, ASI_1, ASI_1, ASI_1, ASI_1, ASI_1 
                 )

# add ASI_p mean ####
ASI_p_by_BMI <- cl_data %>%
  group_by(BMI_levels) %>%
  summarise(ASI_p_mean = round(mean(ASI_p, na.rm = TRUE), 2))%>%
  rename(characteristic = BMI_levels)  # Rename the first column

ASI_p_by_sex <- cl_data %>%
  group_by(Sex) %>%
  summarise(ASI_p_mean = round(mean(ASI_p, na.rm = TRUE), 2))%>%
  rename(characteristic = Sex)  # Rename the first column

ASI_p_by_race <- cl_data %>%
  group_by(Race) %>%
  summarise(ASI_p_mean = round(mean(ASI_p, na.rm = TRUE), 2))%>%
  rename(characteristic = Race)  # Rename the first column

ASI_p_by_ethnicity <- cl_data %>%
  group_by(Ethnicity) %>%
  summarise(ASI_p_mean = round(mean(ASI_p, na.rm = TRUE), 2))%>%
  rename(characteristic = Ethnicity)  # Rename the first column

ASI_p_by_tobacco <- cl_data %>%
  group_by(Tobacco.user) %>%
  summarise(ASI_p_mean = round(mean(ASI_p, na.rm = TRUE), 2))%>%
  rename(characteristic = Tobacco.user) 

ASI_p_by_Consume.alcohol <- cl_data %>%
  group_by(Consume.alcohol) %>%
  summarise(ASI_p_mean = round(mean(ASI_p, na.rm = TRUE), 2))%>%
  rename(characteristic = Consume.alcohol) 

# ASI_p_by_1 <- cl_data %>%
#   group_by(Vigorous.physical.activities.outside.of.work) %>%
#   summarise(ASI_p_mean = round(mean(ASI_p, na.rm = TRUE), 2))%>%
#   rename(characteristic = Vigorous.physical.activities.outside.of.work) 
# 
# ASI_p_by_2 <- cl_data %>%
#   group_by(Moderate.physical.activities.outside.of.work) %>%
#   summarise(ASI_p_mean = round(mean(ASI_p, na.rm = TRUE), 2))%>%
#   rename(characteristic = Moderate.physical.activities.outside.of.work) 

ASI_p_by_3 <- cl_data %>%
  group_by(Rank) %>%
  summarise(ASI_p_mean = round(mean(ASI_p, na.rm = TRUE), 2))%>%
  rename(characteristic = Rank) 

ASI_p_table <- cl_data %>%
  group_by(Total) %>%
  summarise(ASI_p_mean = mean(ASI_p, na.rm = TRUE)) %>%
  rename(characteristic = Total)  # Rename the first column

ASI_p_1 <- ASI_p_table %>% mutate(characteristic = NA, ASI_p_mean = NA)

ASI_p <- bind_rows(ASI_p_1,
                  ASI_p_table, ASI_p_1, ASI_p_by_BMI, 
                  ASI_p_1, ASI_p_by_sex, 
                  ASI_p_1, ASI_p_by_race, 
                  ASI_p_1, ASI_p_by_ethnicity,
                  ASI_p_1, ASI_p_by_tobacco, 
                  ASI_p_1, ASI_p_by_Consume.alcohol,
                  # ASI_p_1, ASI_p_by_1, 
                  # ASI_p_1, ASI_p_by_2, 
                  ASI_p_1, ASI_p_by_3
                  # ASI_p_1, ASI_p_1, ASI_p_1, ASI_p_1, 
                  # ASI_p_1, ASI_p_1, ASI_p_1, ASI_p_1, ASI_p_1, ASI_p_1, ASI_p_1, ASI_p_1, 
                  # ASI_p_1, ASI_p_1, ASI_p_1, ASI_p_1, ASI_p_1, ASI_p_1, ASI_p_1, ASI_p_1 
                  )

# add ASI_c mean ####
ASI_c_by_BMI <- cl_data %>%
  group_by(BMI_levels) %>%
  summarise(ASI_c_mean = round(mean(ASI_c, na.rm = TRUE), 2))%>%
  rename(characteristic = BMI_levels)  # Rename the first column

ASI_c_by_sex <- cl_data %>%
  group_by(Sex) %>%
  summarise(ASI_c_mean = round(mean(ASI_c, na.rm = TRUE), 2))%>%
  rename(characteristic = Sex)  # Rename the first column

ASI_c_by_race <- cl_data %>%
  group_by(Race) %>%
  summarise(ASI_c_mean = round(mean(ASI_c, na.rm = TRUE), 2))%>%
  rename(characteristic = Race)  # Rename the first column

ASI_c_by_ethnicity <- cl_data %>%
  group_by(Ethnicity) %>%
  summarise(ASI_c_mean = round(mean(ASI_c, na.rm = TRUE), 2))%>%
  rename(characteristic = Ethnicity)  # Rename the first column

ASI_c_by_tobacco <- cl_data %>%
  group_by(Tobacco.user) %>%
  summarise(ASI_c_mean = round(mean(ASI_c, na.rm = TRUE), 2))%>%
  rename(characteristic = Tobacco.user) 

ASI_c_by_Consume.alcohol <- cl_data %>%
  group_by(Consume.alcohol) %>%
  summarise(ASI_c_mean = round(mean(ASI_c, na.rm = TRUE), 2))%>%
  rename(characteristic = Consume.alcohol) 

# ASI_c_by_1 <- cl_data %>%
#   group_by(Vigorous.physical.activities.outside.of.work) %>%
#   summarise(ASI_c_mean = round(mean(ASI_c, na.rm = TRUE), 2))%>%
#   rename(characteristic = Vigorous.physical.activities.outside.of.work) 
# 
# ASI_c_by_2 <- cl_data %>%
#   group_by(Moderate.physical.activities.outside.of.work) %>%
#   summarise(ASI_c_mean = round(mean(ASI_c, na.rm = TRUE), 2))%>%
#   rename(characteristic = Moderate.physical.activities.outside.of.work) 

ASI_c_by_3 <- cl_data %>%
  group_by(Rank) %>%
  summarise(ASI_c_mean = round(mean(ASI_c, na.rm = TRUE), 2))%>%
  rename(characteristic = Rank) 

ASI_c_table <- cl_data %>%
  group_by(Total) %>%
  summarise(ASI_c_mean = mean(ASI_c, na.rm = TRUE)) %>%
  rename(characteristic = Total)  # Rename the first column

ASI_c_1 <- ASI_c_table %>% mutate(characteristic = NA, ASI_c_mean = NA)

ASI_c <- bind_rows(ASI_c_1,
                  ASI_c_table, ASI_c_1, ASI_c_by_BMI, 
                  ASI_c_1, ASI_c_by_sex, 
                  ASI_c_1, ASI_c_by_race, 
                  ASI_c_1, ASI_c_by_ethnicity,
                  ASI_c_1, ASI_c_by_tobacco, 
                  ASI_c_1, ASI_c_by_Consume.alcohol,
                  # ASI_c_1, ASI_c_by_1, 
                  # ASI_c_1, ASI_c_by_2, 
                  ASI_c_1, ASI_c_by_3
                  # ASI_c_1, ASI_c_1, ASI_c_1, ASI_c_1, 
                  # ASI_c_1, ASI_c_1, ASI_c_1, ASI_c_1, ASI_c_1, ASI_c_1, ASI_c_1, ASI_c_1, 
                  # ASI_c_1, ASI_c_1, ASI_c_1, ASI_c_1, ASI_c_1, ASI_c_1, ASI_c_1, ASI_c_1 
                  )

# add ASI_s mean ####
ASI_s_by_BMI <- cl_data %>%
  group_by(BMI_levels) %>%
  summarise(ASI_s_mean = round(mean(ASI_s, na.rm = TRUE), 2))%>%
  rename(characteristic = BMI_levels)  # Rename the first column

ASI_s_by_sex <- cl_data %>%
  group_by(Sex) %>%
  summarise(ASI_s_mean = round(mean(ASI_s, na.rm = TRUE), 2))%>%
  rename(characteristic = Sex)  # Rename the first column

ASI_s_by_race <- cl_data %>%
  group_by(Race) %>%
  summarise(ASI_s_mean = round(mean(ASI_s, na.rm = TRUE), 2))%>%
  rename(characteristic = Race)  # Rename the first column

ASI_s_by_ethnicity <- cl_data %>%
  group_by(Ethnicity) %>%
  summarise(ASI_s_mean = round(mean(ASI_s, na.rm = TRUE), 2))%>%
  rename(characteristic = Ethnicity)  # Rename the first column

ASI_s_by_tobacco <- cl_data %>%
  group_by(Tobacco.user) %>%
  summarise(ASI_s_mean = round(mean(ASI_s, na.rm = TRUE), 2))%>%
  rename(characteristic = Tobacco.user) 

ASI_s_by_Consume.alcohol <- cl_data %>%
  group_by(Consume.alcohol) %>%
  summarise(ASI_s_mean = round(mean(ASI_s, na.rm = TRUE), 2))%>%
  rename(characteristic = Consume.alcohol) 

# ASI_s_by_1 <- cl_data %>%
#   group_by(Vigorous.physical.activities.outside.of.work) %>%
#   summarise(ASI_s_mean = round(mean(ASI_s, na.rm = TRUE), 2))%>%
#   rename(characteristic = Vigorous.physical.activities.outside.of.work) 
# 
# ASI_s_by_2 <- cl_data %>%
#   group_by(Moderate.physical.activities.outside.of.work) %>%
#   summarise(ASI_s_mean = round(mean(ASI_s, na.rm = TRUE), 2))%>%
#   rename(characteristic = Moderate.physical.activities.outside.of.work) 

ASI_s_by_3 <- cl_data %>%
  group_by(Rank) %>%
  summarise(ASI_s_mean = round(mean(ASI_s, na.rm = TRUE), 2))%>%
  rename(characteristic = Rank) 

ASI_s_table <- cl_data %>%
  group_by(Total) %>%
  summarise(ASI_s_mean = mean(ASI_s, na.rm = TRUE)) %>%
  rename(characteristic = Total)  # Rename the first column

ASI_s_1 <- ASI_s_table %>% mutate(characteristic = NA, ASI_s_mean = NA)

ASI_s <- bind_rows(ASI_s_1,
                  ASI_s_table, ASI_s_1, ASI_s_by_BMI, 
                  ASI_s_1, ASI_s_by_sex, 
                  ASI_s_1, ASI_s_by_race, 
                  ASI_s_1, ASI_s_by_ethnicity,
                  ASI_s_1, ASI_s_by_tobacco, 
                  ASI_s_1, ASI_s_by_Consume.alcohol,
                  # ASI_s_1, ASI_s_by_1, 
                  # ASI_s_1, ASI_s_by_2, 
                  ASI_s_1, ASI_s_by_3
                  # ASI_s_1, ASI_s_1, ASI_s_1, ASI_s_1, 
                  # ASI_s_1, ASI_s_1, ASI_s_1, ASI_s_1, ASI_s_1, ASI_s_1, ASI_s_1, ASI_s_1, 
                  # ASI_s_1, ASI_s_1, ASI_s_1, ASI_s_1, ASI_s_1, ASI_s_1, ASI_s_1, ASI_s_1
                  )

# add FAST mean ####
FAST_by_BMI <- cl_data %>%
  group_by(BMI_levels) %>%
  summarise(FAST_mean = round(mean(FAST, na.rm = TRUE), 2))%>%
  rename(characteristic = BMI_levels)  # Rename the first column

FAST_by_sex <- cl_data %>%
  group_by(Sex) %>%
  summarise(FAST_mean = round(mean(FAST, na.rm = TRUE), 2))%>%
  rename(characteristic = Sex)  # Rename the first column

FAST_by_race <- cl_data %>%
  group_by(Race) %>%
  summarise(FAST_mean = round(mean(FAST, na.rm = TRUE), 2))%>%
  rename(characteristic = Race)  # Rename the first column

FAST_by_ethnicity <- cl_data %>%
  group_by(Ethnicity) %>%
  summarise(FAST_mean = round(mean(FAST, na.rm = TRUE), 2))%>%
  rename(characteristic = Ethnicity)  # Rename the first column

FAST_by_tobacco <- cl_data %>%
  group_by(Tobacco.user) %>%
  summarise(FAST_mean = round(mean(FAST, na.rm = TRUE), 2))%>%
  rename(characteristic = Tobacco.user) 

FAST_by_Consume.alcohol <- cl_data %>%
  group_by(Consume.alcohol) %>%
  summarise(FAST_mean = round(mean(FAST, na.rm = TRUE), 2))%>%
  rename(characteristic = Consume.alcohol) 

# FAST_by_1 <- cl_data %>%
#   group_by(Vigorous.physical.activities.outside.of.work) %>%
#   summarise(FAST_mean = round(mean(FAST, na.rm = TRUE), 2))%>%
#   rename(characteristic = Vigorous.physical.activities.outside.of.work) 
# 
# FAST_by_2 <- cl_data %>%
#   group_by(Moderate.physical.activities.outside.of.work) %>%
#   summarise(FAST_mean = round(mean(FAST, na.rm = TRUE), 2))%>%
#   rename(characteristic = Moderate.physical.activities.outside.of.work) 

FAST_by_3 <- cl_data %>%
  group_by(Rank) %>%
  summarise(FAST_mean = round(mean(FAST, na.rm = TRUE), 2))%>%
  rename(characteristic = Rank) 

FAST_table <- cl_data %>%
  group_by(Total) %>%
  summarise(FAST_mean = mean(FAST, na.rm = TRUE)) %>%
  rename(characteristic = Total)  # Rename the first column

FAST_1 <- FAST_table %>% mutate(characteristic = NA, FAST_mean = NA)

FAST <- bind_rows(FAST_1,
                  FAST_table, FAST_1, FAST_by_BMI, 
                  FAST_1, FAST_by_sex, 
                  FAST_1, FAST_by_race, 
                  FAST_1, FAST_by_ethnicity,
                  FAST_1, FAST_by_tobacco, 
                  FAST_1, FAST_by_Consume.alcohol,
                  # FAST_1, FAST_by_1, 
                  # FAST_1, FAST_by_2, 
                  FAST_1, FAST_by_3
                  # FAST_1, FAST_1, FAST_1, FAST_1, 
                  # FAST_1, FAST_1, FAST_1, FAST_1, FAST_1, FAST_1, FAST_1, FAST_1, 
                  # FAST_1, FAST_1, FAST_1, FAST_1, FAST_1, FAST_1, FAST_1, FAST_1 
                  )

# add PCL mean ####
PCL_by_BMI <- cl_data %>%
  group_by(BMI_levels) %>%
  summarise(PCL_mean = round(mean(PCL, na.rm = TRUE), 2))%>%
  rename(characteristic = BMI_levels)  # Rename the first column

PCL_by_sex <- cl_data %>%
  group_by(Sex) %>%
  summarise(PCL_mean = round(mean(PCL, na.rm = TRUE), 2))%>%
  rename(characteristic = Sex)  # Rename the first column

PCL_by_race <- cl_data %>%
  group_by(Race) %>%
  summarise(PCL_mean = round(mean(PCL, na.rm = TRUE), 2))%>%
  rename(characteristic = Race)  # Rename the first column

PCL_by_ethnicity <- cl_data %>%
  group_by(Ethnicity) %>%
  summarise(PCL_mean = round(mean(PCL, na.rm = TRUE), 2))%>%
  rename(characteristic = Ethnicity)  # Rename the first column

PCL_by_tobacco <- cl_data %>%
  group_by(Tobacco.user) %>%
  summarise(PCL_mean = round(mean(PCL, na.rm = TRUE), 2))%>%
  rename(characteristic = Tobacco.user) 

PCL_by_Consume.alcohol <- cl_data %>%
  group_by(Consume.alcohol) %>%
  summarise(PCL_mean = round(mean(PCL, na.rm = TRUE), 2))%>%
  rename(characteristic = Consume.alcohol) 

# PCL_by_1 <- cl_data %>%
#   group_by(Vigorous.physical.activities.outside.of.work) %>%
#   summarise(PCL_mean = round(mean(PCL, na.rm = TRUE), 2))%>%
#   rename(characteristic = Vigorous.physical.activities.outside.of.work) 
# 
# PCL_by_2 <- cl_data %>%
#   group_by(Moderate.physical.activities.outside.of.work) %>%
#   summarise(PCL_mean = round(mean(PCL, na.rm = TRUE), 2))%>%
#   rename(characteristic = Moderate.physical.activities.outside.of.work) 

PCL_by_3 <- cl_data %>%
  group_by(Rank) %>%
  summarise(PCL_mean = round(mean(PCL, na.rm = TRUE), 2))%>%
  rename(characteristic = Rank) 

PCL_table <- cl_data %>%
  group_by(Total) %>%
  summarise(PCL_mean = mean(PCL, na.rm = TRUE)) %>%
  rename(characteristic = Total)  # Rename the first column

PCL_1 <- PCL_table %>% mutate(characteristic = NA, PCL_mean = NA)

PCL <- bind_rows(PCL_1,
                  PCL_table, PCL_1, PCL_by_BMI, 
                  PCL_1, PCL_by_sex, 
                  PCL_1, PCL_by_race, 
                  PCL_1, PCL_by_ethnicity,
                  PCL_1, PCL_by_tobacco, 
                  PCL_1, PCL_by_Consume.alcohol,
                  # PCL_1, PCL_by_1, 
                  # PCL_1, PCL_by_2, 
                  PCL_1, PCL_by_3
                  # PCL_1, PCL_1, PCL_1, PCL_1, 
                  # PCL_1, PCL_1, PCL_1, PCL_1, PCL_1, PCL_1, PCL_1, PCL_1, 
                  # PCL_1, PCL_1, PCL_1, PCL_1, PCL_1, PCL_1, PCL_1, PCL_1 
                 )

```

basic gtsummary demographic table to flex table
```{r}
# add the mean values to the table ####
demographic_table <- demographic_table %>%
  modify_table_body(
    ~ .x %>%
      mutate(`CES-D-m (Mean Score)` = round(cesd$CESD_mean, 2),
             `ASI-m (Mean Score)` = round(ASI$ASI_mean, 2),
             `ASI-p-m (Mean Score)` = round(ASI_p$ASI_p_mean, 2),
             `ASI-c-m (Mean Score)` = round(ASI_c$ASI_c_mean, 2),
             `ASI-s-m (Mean Score)` = round(ASI_s$ASI_s_mean, 2),
             `FAST-m (Mean Score)` = round(FAST$FAST_mean, 2),
             `PCL-m (Mean Score)` = round(PCL$PCL_mean, 2))
  ) %>%
  modify_header(
    `CES-D-m (Mean Score)` = "**CES-D-m (Mean)**",
    `ASI-m (Mean Score)` = "**ASI-m (Mean)**",
    `ASI-p-m (Mean Score)` = "**ASI-p-m (Mean)**",
    `ASI-c-m (Mean Score)` = "**ASI-c-m (Mean)**",
    `ASI-s-m (Mean Score)` = "**ASI-s-m (Mean)**",
    `FAST-m (Mean Score)` = "**FAST-m (Mean)**",
    `PCL-m (Mean Score)` = "**PCL-m (Mean)**"
  )

# 转换为可输出格式 ####
final_table <- demographic_table %>%
  as_flex_table() %>%
  flextable::autofit() 

```


## 4. merge the two FLEX table into big flextable and edit the flextable
```{r}
# Step 1: 提取两张 flextable 的 body 内容
demographic_body <- final_table$body$dataset
multichoicequest_body <- multichoicequest_flextable$body$dataset

# Step 2: 合并两张表的 body
combined_body <- rbind(demographic_body, multichoicequest_body)

# step 3: 替换 "0 (NA%)" 为 NA
combined_body <- combined_body %>%
  mutate(stat_0 = ifelse(stat_0 == "0 (NA%)", NA, stat_0))

combined_body <-  combined_body %>%
  rename(
    Variables = label,
    `Overall, N=35(100%)` = stat_0
  )

# step 4: arrange by percentage
# NA rows to divide into subsets
divider_indices <- which(is.na(combined_body$`Overall, N=35(100%)`))

#add ids to each subset
combined_body <- combined_body %>%
  mutate(group_id = cumsum(is.na(`Overall, N=35(100%)`)))

# get the percantage for sorting
sorted_combined_body <- combined_body %>%
  mutate(percentage = as.numeric(gsub(".*\\((.*?)%\\)", "\\1", `Overall, N=35(100%)`)))
# set the percentage of title as 100 for sorting
sorted_combined_body$percentage[divider_indices] <- 100

# sort each subset
sorted_combined_body <- sorted_combined_body %>%
  group_by(group_id) %>%
  arrange(desc(percentage), .by_group=TRUE) %>%
  ungroup()

# drop the percentage column and group_id
sorted_combined_body %<>% select(!all_of(c("group_id","percentage")))

# step 5: transfer to flextable
combined_table <- flextable(sorted_combined_body) %>%
  flextable::autofit()%>% 
   flextable::width(width = 5)%>% 
   flextable::line_spacing(space = 0.70, part = "body")  

# step 6：indent and bold the rows
# get the exclude words
exclude_keywords <- c("Total", "BMI_levels", "Sex", "Race", 
                      "Ethnicity", "Tobacco user", "Consume alcohol", 
                      "Vigorous physical activities outside of work", 
                      "Moderate physical activities outside of work", 
                      "Rank", "Years", "Activities per Week", 
                      "Scenes per Week", "multiple choice")

# get the body of combined table
combined_body <- combined_table$body$dataset

# get the row numbers of not indent
excluded_rows <- which(
  apply(combined_body, 1, function(row) {
    any(grepl(paste(exclude_keywords, collapse = "|"), row, ignore.case = TRUE))
  })
)

# get rows to indent
rows_to_indent <- setdiff(seq_len(nrow(combined_body)), excluded_rows)

# indent the rows
combined_table <- combined_table %>%
  flextable::padding(
    i = rows_to_indent,    
    padding.left = 20,     # set the width of indent
    part = "body"          # apply to body of combined_table
  )

# bold 
combined_table <- combined_table %>%
  flextable::bold(
    i = excluded_rows,  
    part = "body"
  )

# set width for each column
combined_table <- combined_table %>% 
  flextable::width(j = c(1, 2:9), width = c(5.5, 1.5, rep(1,7)))  

combined_table
```



## 5. print the table
```{r}
# 打印表格 ####
ft <- bg(combined_table, bg = "white", part = "all")
# save_as_image(ft, path = "demographic_table.png")

# doc <- read_docx() %>%
#   body_add_flextable(value = final_table )
# 
# print(doc, target = "demographic_table.docx")

# save_as_html(combined_table, path = "demographic_table.html")
```
## 6. calculate the significance of difference between rows
```{r}
# get the dataframe first
demosigni <- read_excel("datafordemosignifi.xlsx")
demosigni <- na.omit(demosigni)
demosigni <- demosigni[,-2]
```

do the permutation test
```{r}
set.seed(123)

# initialize an empty data frame to store the results
test_results <- data.frame(
  category = character(),
  Variables = character(),
  p_value = numeric(),
  stringsAsFactors = FALSE
)

n_permutations <- 1000

# loop over each category
categories <- unique(demosigni$category)
for (cat in categories) {
  # subset the data for the current category
  category_data <- subset(demosigni, category == cat)
  
  # Extract the basic row
  basic_row <- category_data %>% 
    filter(label == "basic") %>%
    select(`CES-D-m (Mean Score)`:`PCL-m (Mean Score)`) %>%
    unlist(use.names = FALSE) # convert to a numeric vector
  
  # loop over each other_row in the category
  for (i in seq_len(nrow(category_data))) {
    other_row <- category_data[i,]
    
    # Skip the basic row
    if (other_row$label == "basic") next
  
    # Extract the other row's data
    other_row_data <- other_row %>%
      select(`CES-D-m (Mean Score)`:`PCL-m (Mean Score)`) %>%
      unlist(use.names = FALSE) # convert to a numeric vector
    
    # calculate the observed statistic (mean difference)
    observed_stat <- mean(other_row_data-basic_row)
    
    # Generate the null distribution
    permuted_stats <- numeric(n_permutations)
    for (j in seq_len(n_permutations)) {
      # Randomly flip the signs of the differences
      permuted_diff <- sample(c(1,-1), length(basic_row),
                              replace=TRUE)*(other_row_data-basic_row)
      permuted_stats[j] <- mean(permuted_diff)
    }
    
    # Calculate the p-value
    p_value <- mean(abs(permuted_stats) >= abs(observed_stat))
    
    # store the results
    test_results <- rbind(
      test_results, 
      data.frame(
      category = cat,
      Variables = other_row$Variables,
      p_value = p_value
    ))
  }
}

test_results <- test_results %>%
  mutate(
    significance = case_when(
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      TRUE ~ NA
    )
  )

# View the results
print(test_results)

```


# heatmap for mental health
```{r}

all_correlations <- cor(mental, use = "complete.obs", method = "spearman") 

corr <- all_correlations
all_correlations <- as.data.frame(all_correlations)

# Melt the correlation matrix into long format
cor_melt <- melt(corr) 
```

```{r}
pheatmap(all_correlations, display_numbers = TRUE, color = colorRampPalette(c("purple", "white", "orange"))(50))
```

# histogram of mental health data
```{r}
par(mfrow = c(2,5))
for (i in 2:dim(mental)[2]) {
  Columname = colnames(mental)[i]
  hist(mental[[Columname]], main = paste(Columname),  xlab = paste(Columname, "Values"), col = "lightblue", border = "black")
}
shapiro.test(mental$ASI_p)
shapiro.test(mental$ASI_c)
shapiro.test(mental$ASI_s)
shapiro.test(mental$ASI)
shapiro.test(mental$FAST)
shapiro.test(mental$CESD)
```

# Modeling & scatter plot matrices
## prepare dataset
Before running this chunk, run the chunks in 1st and 3rd dataset code, including box plots and deleting non-significant elements.
Note: we use wipe_diff and personal_diff **without** those non-significant elements
we use *df* as the dataset of fitting models
```{r}
# calculate the sum of neurotoxicant concentrations
tox_diff <- wipe_diff
tox_diff$sum_wipe <- rowSums(tox_diff[,-1], na.rm = TRUE)
tox_diff <- tox_diff %>% left_join(personal_diff, by="FFID")
tox_diff$sum_air <- rowSums(tox_diff[,grep("_air$", names(tox_diff))], na.rm = TRUE)

# get the database for the model
quest_model <- read_excel("data_questionformodel.xlsx", sheet = "data_adj2")
df <- quest_model  %>%
  full_join(tox_diff %>% select(FFID, sum_wipe, sum_air), by="FFID") %>%
  filter(!row_number() %in% 29) 

# change the type of binary variables from integral to factor
# df[,c("ASI_bi","FAST_bi","CESD_bi","PCL_bi")] <- lapply(df[,c("ASI_bi","FAST_bi","CESD_bi","PCL_bi")],factor)

# 14:103 are categorical variables from sex to captain
# df[,14:103] <- lapply(df[,14:103], factor) 
```

## scatter plot matrices
sum_air vs 7 mental
```{r}
# scatter_df <- df %>% select(FFID, sum_wipe, sum_air, ASI:ASI_s, FAST, CESD, PCL, BMI,
                          # Years.as.a.Firefighter:Average.hours.on.fire.scenes.per.week)
scatter_df <- df %>% select(sum_air, FAST, CESD, PCL, ASI, ASI_p, ASI_c, ASI_s)

# Define a custom panel function to add correlation coefficients
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor = 1.2) {
  
  # Save the current graphical parameters and ensure they're restored on exit
  op <- par(usr = c(0, 1, 0, 1))  # Set user coordinates to 0-1 for placing text
  on.exit(par(op))  # Restore original graphical parameters when the function exits

  # Calculate correlation coefficient
  r <- cor(x, y, use = "complete.obs")  # Exclude missing values
  txt <- formatC(r, format = "f", digits = digits)  # Format the coefficient

  # Place the text in the middle of the panel
  text(0.5, 0.5, paste0(prefix, txt), cex = cex.cor)
}

# Define a custom lower panel function for scatter plots with styling
panel.points <- function(x, y, ...) {
  points(x, y, pch = 1, col = "black", ...)  # Custom styling for points
}

# Create the scatter plot matrix
pairs(
  scatter_df,
  upper.panel = panel.cor,      # Correlation coefficients in upper panel
  lower.panel = panel.points,   # Custom scatter plots in lower panel
  diag.panel = NULL,            # No diagonal panel
  main = "sum_air vs mental health measurements"
)

# pairs(scatter_df, main = "sum_air vs mental health measurements", pch = 1, col = "black")

```

sum_wipe vs sum_air and 7 mental
```{r}
# scatter_df <- df %>% select(FFID, sum_wipe, sum_air, ASI:ASI_s, FAST, CESD, PCL, BMI,
                            # Years.as.a.Firefighter:Average.hours.on.fire.scenes.per.week)
scatter_df <- df %>% select(sum_wipe, sum_air, FAST, CESD, PCL, ASI, ASI_p, ASI_c, ASI_s)

# Define a custom panel function to add correlation coefficients
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor = 1.2) {
  
  # Save the current graphical parameters and ensure they're restored on exit
  op <- par(usr = c(0, 1, 0, 1))  # Set user coordinates to 0-1 for placing text
  on.exit(par(op))  # Restore original graphical parameters when the function exits

  # Calculate correlation coefficient
  r <- cor(x, y, use = "complete.obs")  # Exclude missing values
  txt <- formatC(r, format = "f", digits = digits)  # Format the coefficient

  # Place the text in the middle of the panel
  text(0.5, 0.5, paste0(prefix, txt), cex = cex.cor)
}

# Define a custom lower panel function for scatter plots with styling
panel.points <- function(x, y, ...) {
  points(x, y, pch = 1, col = "black", ...)  # Custom styling for points
}

# Create the scatter plot matrix
pairs(
  scatter_df,
  upper.panel = panel.cor,      # Correlation coefficients in upper panel
  lower.panel = panel.points,   # Custom scatter plots in lower panel
  diag.panel = NULL,            # No diagonal panel
  main = "sum_wipe, sum_air vs mental health measurements"
)
```


sum_wipe vs sum_air and 4 mental
```{r}
# scatter_df <- df %>% select(FFID, sum_wipe, sum_air, ASI:ASI_s, FAST, CESD, PCL, BMI,
                            # Years.as.a.Firefighter:Average.hours.on.fire.scenes.per.week)
scatter_df <- df %>% select(sum_wipe, sum_air, FAST, CESD, PCL, ASI)

# Define a custom panel function to add correlation coefficients
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor = 1.2) {
  
  # Save the current graphical parameters and ensure they're restored on exit
  op <- par(usr = c(0, 1, 0, 1))  # Set user coordinates to 0-1 for placing text
  on.exit(par(op))  # Restore original graphical parameters when the function exits

  # Calculate correlation coefficient
  r <- cor(x, y, use = "complete.obs")  # Exclude missing values
  txt <- formatC(r, format = "f", digits = digits)  # Format the coefficient

  # Place the text in the middle of the panel
  text(0.5, 0.5, paste0(prefix, txt), cex = cex.cor)
}

# Define a custom lower panel function for scatter plots with styling
panel.points <- function(x, y, ...) {
  points(x, y, pch = 1, col = "black", ...)  # Custom styling for points
}

# Create the scatter plot matrix
pairs(
  scatter_df,
  upper.panel = panel.cor,      # Correlation coefficients in upper panel
  lower.panel = panel.points,   # Custom scatter plots in lower panel
  diag.panel = NULL,            # No diagonal panel
  main = "sum_wipe, sum_air vs mental health measurements"
)
```

sum_wipe vs 4 mental
```{r}
# scatter_df <- df %>% select(FFID, sum_wipe, sum_air, ASI:ASI_s, FAST, CESD, PCL, BMI,
                            # Years.as.a.Firefighter:Average.hours.on.fire.scenes.per.week)
scatter_df <- df %>% select(sum_wipe, FAST, CESD, PCL, ASI)

# Define a custom panel function to add correlation coefficients
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor = 1.2) {
  
  # Save the current graphical parameters and ensure they're restored on exit
  op <- par(usr = c(0, 1, 0, 1))  # Set user coordinates to 0-1 for placing text
  on.exit(par(op))  # Restore original graphical parameters when the function exits

  # Calculate correlation coefficient
  r <- cor(x, y, use = "complete.obs")  # Exclude missing values
  txt <- formatC(r, format = "f", digits = digits)  # Format the coefficient

  # Place the text in the middle of the panel
  text(0.5, 0.5, paste0(prefix, txt), cex = cex.cor)
}

# Define a custom lower panel function for scatter plots with styling
panel.points <- function(x, y, ...) {
  points(x, y, pch = 1, col = "black", ...)  # Custom styling for points
}

# Create the scatter plot matrix
pairs(
  scatter_df,
  upper.panel = panel.cor,      # Correlation coefficients in upper panel
  lower.panel = panel.points,   # Custom scatter plots in lower panel
  diag.panel = NULL,            # No diagonal panel
  main = "sum_wipe vs 4 mental health measurements"
)
```


sum_air vs 4 mental
```{r}
# scatter_df <- df %>% select(FFID, sum_wipe, sum_air, ASI:ASI_s, FAST, CESD, PCL, BMI,
                            # Years.as.a.Firefighter:Average.hours.on.fire.scenes.per.week)
scatter_df <- df %>% select(sum_air, FAST, CESD, PCL, ASI)

# Define a custom panel function to add correlation coefficients
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor = 1.2) {
  
  # Save the current graphical parameters and ensure they're restored on exit
  op <- par(usr = c(0, 1, 0, 1))  # Set user coordinates to 0-1 for placing text
  on.exit(par(op))  # Restore original graphical parameters when the function exits

  # Calculate correlation coefficient
  r <- cor(x, y, use = "complete.obs")  # Exclude missing values
  txt <- formatC(r, format = "f", digits = digits)  # Format the coefficient

  # Place the text in the middle of the panel
  text(0.5, 0.5, paste0(prefix, txt), cex = cex.cor)
}

# Define a custom lower panel function for scatter plots with styling
panel.points <- function(x, y, ...) {
  points(x, y, pch = 1, col = "black", ...)  # Custom styling for points
}

# Create the scatter plot matrix
pairs(
  scatter_df,
  upper.panel = panel.cor,      # Correlation coefficients in upper panel
  lower.panel = panel.points,   # Custom scatter plots in lower panel
  diag.panel = NULL,            # No diagonal panel
  main = "sum_air vs mental health measurements"
)
```

## model for Mediator
•	ASI (count variable: the score of Anxiety), 
•	ASI_bi (binary variable: have anxiety or not), 
•	ASI_s(count variable: the score of ASI_s), 
•	FAST (count variable)
•	CES-D (count variable)
•	PCL
•	PCL_bi
###logistic regression
sum_wipe + sum_air
```{r}
# independent variables: only neurotoxicants
logistic_ASI <- glm(ASI_bi ~ sum_wipe + sum_air, data = df, family = binomial)
summary(logistic_ASI)

# only neurotoxicants
logistic_FAST <- glm(FAST_bi ~ sum_wipe + sum_air, data = df, family = binomial)
summary(logistic_FAST)

# only neurotoxicants
logistic_CESD <- glm(CESD_bi ~ sum_wipe + sum_air, data = df, family = binomial)
summary(logistic_CESD)

# only neurotoxicants
logistic_PCL <- glm(PCL_bi ~ sum_wipe + sum_air, data = df, family = binomial)
summary(logistic_PCL)

logistic_All_MentalHealth <- glm(All_MentalHealth ~ sum_wipe + sum_air, data = df, family = binomial)
summary(logistic_All_MentalHealth)



```


logistic regression only sum_wipe
```{r}
# independent variables: only neurotoxicants
logistic_ASI <- glm(ASI_bi ~ sum_wipe, data = df, family = binomial)
summary(logistic_ASI)

# only neurotoxicants
logistic_FAST <- glm(FAST_bi ~ sum_wipe, data = df, family = binomial)
summary(logistic_FAST)

# only neurotoxicants
logistic_CESD <- glm(CESD_bi ~ sum_wipe, data = df, family = binomial)
summary(logistic_CESD)

# only neurotoxicants
logistic_PCL <- glm(PCL_bi ~ sum_wipe, data = df, family = binomial)
summary(logistic_PCL)

logistic_All_MentalHealth <- glm(All_MentalHealth ~ sum_wipe, data = df, family = binomial)
summary(logistic_All_MentalHealth)

```


logistic regression only sum_air
```{r}
# independent variables: only neurotoxicants
logistic_ASI <- glm(ASI_bi ~ sum_air, data = df, family = binomial)
summary(logistic_ASI)

# only neurotoxicants
logistic_FAST <- glm(FAST_bi ~ sum_air, data = df, family = binomial)
summary(logistic_FAST)

# only neurotoxicants
logistic_CESD <- glm(CESD_bi ~ sum_air, data = df, family = binomial)
summary(logistic_CESD)

# only neurotoxicants
logistic_PCL <- glm(PCL_bi ~ sum_air, data = df, family = binomial)
summary(logistic_PCL)

logistic_All_MentalHealth <- glm(All_MentalHealth ~ sum_air, data = df, family = binomial)
summary(logistic_All_MentalHealth)

```

all variables logistic regression
```{r}
# all variables
logistic_all_ASI <- glm(ASI_bi ~ ., data = na.omit(df[,c(6,13:110)]), family = binomial)
summary(logistic_all_ASI)
step_all_ASI <- stepAIC(logistic_all_ASI, direction = "both")
summary(step_all_ASI)
```


### simple linear regression sum_air + sum_wipe
```{r}
# only neurotoxicants
simple_ASI <- lm(sqrt(ASI) ~ sum_air + sum_wipe, data = df)
summary(simple_ASI)

# only neurotoxicants
simple_ASI_p <- lm(sqrt(ASI_p) ~ sum_air + sum_wipe, data = df)
summary(simple_ASI_p)

# only neurotoxicants
simple_ASI_c <- lm(sqrt(ASI_c) ~ sum_air + sum_wipe, data = df)
summary(simple_ASI_c)

# only neurotoxicants
simple_ASI_s <- lm(sqrt(ASI_s) ~ sum_air + sum_wipe, data = df)
summary(simple_ASI_s)

# only neurotoxicants
simple_CESD <- lm(sqrt(CESD) ~ sum_air + sum_wipe, data = df)
summary(simple_CESD)

# only neurotoxicants
simple_FAST <- lm(sqrt(FAST) ~ sum_air + sum_wipe, data = df)
summary(simple_FAST)

# only neurotoxicants
simple_PCL <- lm(sqrt(PCL) ~ sum_air + sum_wipe, data = df)
summary(simple_PCL)
```

### check the assumption for linear regression
```{r}
simple_ASI_s <- lm(sqrt(ASI_s) ~ sum_air + sum_wipe, data = df)
summary(simple_ASI_s)

# Linearity: Scatter plots with regression lines
par(mfrow = c(1, 2))  # Split the plotting window
plot(df$sum_air, df$ASI_s, main = "ASI_s vs sum_air")
abline(lm(ASI_s ~ sum_air, data = df), col = "red")
plot(df$sum_wipe, df$ASI_s, main = "ASI_s vs sum_wipe")
abline(lm(ASI_s ~ sum_wipe, data = df), col = "red")

# Independence: Durbin-Watson test
library(car)
durbinWatsonTest(simple_ASI_s)

# Homoscedasticity: Residuals vs. fitted plot
plot(simple_ASI_s, which = 1)

# Normality of Residuals: Q-Q plot and histogram
qqnorm(residuals(simple_ASI_s))
qqline(residuals(simple_ASI_s), col = "red")
hist(residuals(simple_ASI_s), breaks = 30, main = "Residuals Histogram")

# Multicollinearity: Variance Inflation Factor (VIF)
library(car)
vif(simple_ASI_s)
```



### simple linear regression only sum_wipe
```{r}
# only neurotoxicants
simple_ASI <- lm(sqrt(ASI) ~ sum_wipe, data = df)
summary(simple_ASI)

# only neurotoxicants
simple_ASI_p <- lm(sqrt(ASI_p) ~ sum_wipe, data = df)
summary(simple_ASI_p)

# only neurotoxicants
simple_ASI_c <- lm(sqrt(ASI_c) ~ sum_wipe, data = df)
summary(simple_ASI_c)

# only neurotoxicants
simple_ASI_s <- lm(sqrt(ASI_s) ~ sum_wipe, data = df)
summary(simple_ASI_s)

# only neurotoxicants
simple_CESD <- lm(sqrt(CESD) ~ sum_wipe, data = df)
summary(simple_CESD)

# only neurotoxicants
simple_FAST <- lm(sqrt(FAST) ~ sum_wipe, data = df)
summary(simple_FAST)

# only neurotoxicants
simple_PCL <- lm(sqrt(PCL) ~ sum_wipe, data = df)
summary(simple_PCL)
```

### simple linear regression only sum_air
```{r}
# only neurotoxicants
simple_ASI <- lm(ASI ~ sum_air, data = df)
summary(simple_ASI)

# only neurotoxicants
simple_ASI_p <- lm(ASI_p ~ sum_air, data = df)
summary(simple_ASI_p)

# only neurotoxicants
simple_ASI_c <- lm(sqrt(ASI_c) ~ sum_air, data = df)
summary(simple_ASI_c)

# only neurotoxicants
simple_ASI_s <- lm(sqrt(ASI_s) ~ sum_air, data = df)
summary(simple_ASI_s)

# only neurotoxicants
simple_CESD <- lm(sqrt(CESD) ~ sum_air, data = df)
summary(simple_CESD)

# only neurotoxicants
simple_FAST <- lm(sqrt(FAST) ~ sum_air, data = df)
summary(simple_FAST)

# only neurotoxicants
simple_PCL <- lm(sqrt(PCL) ~ sum_air, data = df)
summary(simple_PCL)
```

all variables and stepwise procedure
```{r}
# all variables
simple_all_ASI <- lm(ASI ~ ., data = na.omit(df[,c(2,13:110)])) # 13:110 is all variables
summary(simple_all_ASI)
step_simple_ASI <- stepAIC(simple_all_ASI, direction = "both")
summary(step_simple_ASI)


```


### logistic regression: for Binary variable
•	TraumaOnDuty: traumatic experiences on duty (binary variable), 
•	TraumaInChildhood (binary variable), 
•	FH_Yes (binary variable) is significant
```{r}
# sum_wipe + sum_air
logistic_TraumaOnDuty <- glm(TraumaOnDuty ~ sum_wipe + sum_air, data = df, family = binomial)
summary(logistic_TraumaOnDuty)

logistic_TraumaInChildhood <- glm(TraumaInChildhood ~ sum_wipe + sum_air, data = df, family = binomial)
summary(logistic_TraumaInChildhood)

logistic_FH_Yes <- glm(FH_Yes ~ sum_wipe + sum_air, data = df, family = binomial)
summary(logistic_FH_Yes)

logistic_FH_Yes <- glm(FH_Yes ~ sum_wipe + sum_air, data = df, family = binomial)
summary(logistic_FH_Yes)

# sum_air
logistic_TraumaOnDuty <- glm(TraumaOnDuty ~ sum_air, data = df, family = binomial)
summary(logistic_TraumaOnDuty)

logistic_TraumaInChildhood <- glm(TraumaInChildhood ~ sum_air, data = df, family = binomial)
summary(logistic_TraumaInChildhood)

logistic_FH_Yes <- glm(FH_Yes ~ sum_air, data = df, family = binomial)
summary(logistic_FH_Yes)

# sum_wipe
logistic_TraumaOnDuty <- glm(TraumaOnDuty ~ sum_wipe, data = df, family = binomial)
summary(logistic_TraumaOnDuty)

logistic_TraumaInChildhood <- glm(TraumaInChildhood ~ sum_wipe, data = df, family = binomial)
summary(logistic_TraumaInChildhood)

logistic_FH_Yes <- glm(FH_Yes ~ sum_wipe, data = df, family = binomial)
summary(logistic_FH_Yes)
```

### poisson regression: for count variable
•	ASI	ASI_p	ASI_c	ASI_s	FAST	CESD	PCL	
•	TraumaOnDutyCount (count variable)
•	TraumaInChildhoodCount (count variable)
•	Years.as.a.Firefighter (count variable, rounded the decimals), 
•	Avg.fire-related.activities.per.week (count variable, rounded the decimals), 
•	Avg.hrs.on.fire.scenes.per.week (count variable, rounded the decimals).

sum_wipe
```{r}
library(MASS) 

poisson_ASI <- glm(ASI ~ sum_wipe, data = df, family = poisson)
summary(poisson_ASI)

poisson_ASI_p <- glm(ASI_p ~ sum_wipe, data = df, family = poisson)
summary(poisson_ASI_p)

poisson_ASI_c <- glm(ASI_c ~ sum_wipe, data = df, family = poisson)
summary(poisson_ASI_c)

poisson_ASI_s <- glm(ASI_s ~ sum_wipe, data = df, family = poisson)
summary(poisson_ASI_s)

poisson_FAST <- glm(FAST ~ sum_wipe, data = df, family = poisson)
summary(poisson_FAST)

poisson_CESD <- glm(CESD ~ sum_wipe, data = df, family = poisson)
summary(poisson_CESD)

poisson_PCL <- glm(PCL ~ sum_wipe, data = df, family = poisson)
summary(poisson_PCL)

poisson_MentalHealth_count <- glm(MentalHealth_count ~ sum_wipe, data = df, family = poisson)
summary(poisson_MentalHealth_count)

poisson_TraumaOnDutyCount <- glm(TraumaOnDutyCount ~ sum_wipe, data = df, family = poisson)
summary(poisson_TraumaOnDutyCount)

poisson_TraumaInChildhoodCount <- glm(TraumaInChildhoodCount ~ sum_wipe, data = df, family = poisson)
summary(poisson_TraumaInChildhoodCount)

poisson_YearFF <- glm(Years.as.a.Firefighter ~ sum_wipe, data = df, family = poisson)
summary(poisson_YearFF)

poisson_AvgFire <- glm(Avg.fire.related.activities.per.week ~ sum_wipe, data = df, family = poisson)
summary(poisson_AvgFire)

poisson_AvgHrs <- glm(Avg.hrs.on.fire.scenes.per.week ~ sum_wipe, data = df, family = poisson)
summary(poisson_AvgHrs)
```
sum_air
```{r}
poisson_ASI <- glm(ASI ~ sum_air, data = df, family = poisson)
summary(poisson_ASI)

poisson_ASI_p <- glm(ASI_p ~ sum_air, data = df, family = poisson)
summary(poisson_ASI_p)

poisson_ASI_c <- glm(ASI_c ~ sum_air, data = df, family = poisson)
summary(poisson_ASI_c)

poisson_ASI_s <- glm(ASI_s ~ sum_air, data = df, family = poisson)
summary(poisson_ASI_s)

poisson_FAST <- glm(FAST ~ sum_air, data = df, family = poisson)
summary(poisson_FAST)

poisson_CESD <- glm(CESD ~ sum_air, data = df, family = poisson)
summary(poisson_CESD)

poisson_PCL <- glm(PCL ~ sum_air, data = df, family = poisson)
summary(poisson_PCL)

poisson_MentalHealth_count <- glm(MentalHealth_count ~ sum_air, data = df, family = poisson)
summary(poisson_MentalHealth_count)

poisson_TraumaOnDutyCount <- glm(TraumaOnDutyCount ~ sum_air, data = df, family = poisson)
summary(poisson_TraumaOnDutyCount)

poisson_TraumaInChildhoodCount <- glm(TraumaInChildhoodCount ~ sum_air, data = df, family = poisson)
summary(poisson_TraumaInChildhoodCount)

poisson_YearFF <- glm(Years.as.a.Firefighter ~ sum_air, data = df, family = poisson)
summary(poisson_YearFF)

poisson_AvgFire <- glm(Avg.fire.related.activities.per.week ~ sum_air, data = df, family = poisson)
summary(poisson_AvgFire)

poisson_AvgHrs <- glm(Avg.hrs.on.fire.scenes.per.week ~ sum_air, data = df, family = poisson)
summary(poisson_AvgHrs)
```

sum_air+sum_wipe
```{r}
poisson_ASI <- glm(ASI ~ sum_air+sum_wipe, data = df, family = poisson)
summary(poisson_ASI)

poisson_ASI_p <- glm(ASI_p ~ sum_air+sum_wipe, data = df, family = poisson)
summary(poisson_ASI_p)

poisson_ASI_c <- glm(ASI_c ~ sum_air+sum_wipe, data = df, family = poisson)
summary(poisson_ASI_c)

poisson_ASI_s <- glm(ASI_s ~ sum_air+sum_wipe, data = df, family = poisson)
summary(poisson_ASI_s)

poisson_FAST <- glm(FAST ~ sum_air+sum_wipe, data = df, family = poisson)
summary(poisson_FAST)

poisson_CESD <- glm(CESD ~ sum_air+sum_wipe, data = df, family = poisson)
summary(poisson_CESD)

poisson_PCL <- glm(PCL ~ sum_air+sum_wipe, data = df, family = poisson)
summary(poisson_PCL)

poisson_MentalHealth_count <- glm(MentalHealth_count ~ sum_air+sum_wipe, data = df, family = poisson)
summary(poisson_MentalHealth_count)

poisson_TraumaOnDutyCount <- glm(TraumaOnDutyCount ~ sum_air+sum_wipe, data = df, family = poisson)
summary(poisson_TraumaOnDutyCount)

poisson_TraumaInChildhoodCount <- glm(TraumaInChildhoodCount ~ sum_air+sum_wipe, data = df, family = poisson)
summary(poisson_TraumaInChildhoodCount)

poisson_YearFF <- glm(Years.as.a.Firefighter ~ sum_air+sum_wipe, data = df, family = poisson)
summary(poisson_YearFF)

poisson_AvgFire <- glm(Avg.fire.related.activities.per.week ~ sum_air+sum_wipe, data = df, family = poisson)
summary(poisson_AvgFire)

poisson_AvgHrs <- glm(Avg.hrs.on.fire.scenes.per.week ~ sum_air+sum_wipe, data = df, family = poisson)
summary(poisson_AvgHrs)
```




## model for Outcome
•	Outcome: ASI	ASI_p	ASI_c	ASI_s	ASI_bi	FAST	FAST_bi	CESD	CESD_bi	PCL	PCL_bi
  MentalHealth_count All_MentalHealth
•	Predictor (exposure): sum_air sum_wipe
•	Mediator: ASI, ASI_s, FAST, Avg.hrs.on.fire.scenes.per.week, Years.as.a.Firefighter, PCL

### outcome model & mediator model: poisson regression
sum_air -> TraumaOnDutyCount -> FAST/CESD/PCL/ASI/MentalHealth_count
sum_wipe -> TraumaOnDutyCount -> FAST/CESD/PCL/ASI/MentalHealth_count
sum_air -> TraumaInChildhoodCount -> FAST/CESD/PCL/ASI/MentalHealth_count
sum_wipe -> TraumaInChildhoodCount -> FAST/CESD/PCL/ASI/MentalHealth_count
sum_wipe -> Years.as.a.Firefighter -> FAST/CESD/PCL/*ASI*/MentalHealth_count/*ASI_s*
sum_wipe -> Avg.hrs.on.fire.scenes.per.week -> FAST/CESD/*ASI*/PCL/MentalHealth_count/*ASI_s*
sum_wipe -> ASI_s -> FAST/CESD/PCL
sum_wipe -> ASI -> FAST/CESD/PCL
sum_air -> Years.as.a.Firefighter -> FAST/CESD/PCL/ASI/MentalHealth_count/ASI_s
sum_air -> Avg.hrs.on.fire.scenes.per.week -> FAST/CESD/ASI/PCL/MentalHealth_count/ASI_s
sum_air -> ASI_s -> FAST/CESD/PCL
sum_air -> ASI -> FAST/CESD/PCL
```{r}
mediator_model <- glm(Years.as.a.Firefighter ~ sum_wipe, family = poisson, data = df)
outcome_model <- glm(ASI_s ~ sum_wipe + Years.as.a.Firefighter , family = poisson, data = df)
mediation_result <- mediate(mediator_model, outcome_model, 
                            treat = "sum_wipe", mediator = "Years.as.a.Firefighter", 
                            boot = TRUE, sims = 1000)
summary(mediation_result)
```
### mediator model:logistic regression; outcome model:poisson regression
sum_air/sum_wipe -> FH_Yes -> FAST/CESD/ASI/PCL/MentalHealth_count/ASI_s
```{r}
mediator_model <- glm(FH_Yes ~ sum_air, family = binomial, data = df)
outcome_model <- glm(MentalHealth_count ~ sum_air + FH_Yes, family = poisson, data = df)
mediation_result <- mediate(mediator_model, outcome_model, 
                            treat = "sum_air", mediator = "FH_Yes", 
                            boot = TRUE, sims = 1000)
summary(mediation_result)
```

### outcome model & mediator model: logistic regression
sum_air/sum_wipe -> FH_Yes -> FAST_bi/CESD_bi/ASI_bi/PCL_bi/All_MentalHealth
```{r}

```


## exact logistic regression
FH_Yes -> FAST_bi/CESD_bi/ASI_bi/PCL_bi/All_MentalHealth
```{r}
# Load necessary package
library(elrm)

# Convert variables to factors
df$FH_Yes <- as.factor(df$FH_Yes)
df$ASI_bi <- as.factor(df$ASI_bi)

# Create a summary table with counts
collapsed_df <- as.data.frame(table(df$ASI_bi, df$FH_Yes))

# Rename columns
colnames(collapsed_df) <- c("ASI_bi", "FH_Yes", "Freq")

# Reshape data to wide format
elrm_data <- reshape(collapsed_df, timevar = "FH_Yes", idvar = "ASI_bi", direction = "wide")

# Rename columns for elrm format
colnames(elrm_data) <- c("ASI_bi", "n0", "n1")  # n0 = FH_Yes=0, n1 = FH_Yes=1

# Create total trials column
elrm_data$n <- elrm_data$n0 + elrm_data$n1

# Ensure n1 and n are numeric
elrm_data$n1 <- as.numeric(elrm_data$n1)
elrm_data$n <- as.numeric(elrm_data$n)

# Fit exact logistic regression model with proportion format
exact_model <- elrm(formula = n1/n ~ ASI_bi, 
                    interest = ~ASI_bi, 
                    dataset = elrm_data, 
                    iter = 22000, burnIn = 2000)

# View results
summary(exact_model)

```


## Old Code Mediation Analysis
since the incidence of PCL_bi is 11.43% > 10%, the outcome is common (not rare). This made us use log-binomial model for the outcome. 

### Mediator: PCL exposure: sum_wipe
Outcome: ASI_s_bi
```{r}
# convert PCL_bi to numeric
df$PCL_bi <- as.numeric(as.character(df$PCL_bi))

# Fit mediator model (Linear Regression)
mediator_model <- lm(log(PCL+1) ~ sum_wipe, data = df)

# Fit outcome model (Log-binomial Model for PCL_bi)
outcome_model <- glm(ASI_s_bi ~ sum_wipe + log(PCL+1), 
                     data = df, 
                     family = poisson(link = "log"))

# Run mediation analysis with bootstrapping
mediation_result <- mediate(mediator_model, outcome_model, 
                            treat = "sum_wipe", mediator = "ASI_s",
                            boot = TRUE, sims = 5000)  # Increase sims for stability

# Print results
summary(mediation_result)
```


### mediator: ASI_s (the score of ASI_s)  exposure: sum_wipe + sum_air 
outcome: PCL_bi (binary variable) 
old code:
```{r}
# convert PCL_bi to numeric
df$PCL_bi <- as.numeric(as.character(df$PCL_bi))

# Fit mediator model (Linear Regression)
mediator_model <- lm(ASI_s ~ sum_wipe + sum_air, data = df)

# 1: Fit outcome model (Log-binomial Model for PCL_bi): for common outcome
outcome_model <- glm(PCL_bi ~ ASI_s + sum_wipe:ASI_s + sum_air:ASI_s, 
                     data = df, 
                     family = poisson(link = "log"))

# Or 2: Fit outcome model (Logistic Regression Model for PCL_bi) with interaction terms: for handling numerical stability better
outcome_model <- glm(PCL_bi ~ sum_wipe * ASI_s + sum_air * ASI_s + ASI_s, 
                     data = df, 
                     family = binomial(link = "logit"))

# Or 3: Fit a zero-inflated Poisson model: for more zeros
outcome_model <- zeroinfl(PCL_bi ~ sum_wipe * ASI_s + sum_air * ASI_s + ASI_s, 
                          data = df, 
                          dist = "poisson")

# Or 4: Fit a penalized logistic regression model: for small samples and perfect separation
# Prepare data for glmnet
X <- model.matrix(PCL_bi ~ sum_wipe * ASI_s + sum_air * ASI_s + ASI_s, data = df)[, -1]
y <- df$PCL_bi

# Fit regularized logistic regression model using glmnet (Elastic Net)
cv_model <- cv.glmnet(X, y, family = "binomial", alpha = 0.5)  # Elastic Net

# Get the best lambda value
best_lambda <- cv_model$lambda.min

# Fit the final model using the best lambda
outcome_model <- glmnet(X, y, family = "binomial", alpha = 0.5, lambda = best_lambda)

# Summary of the model
print(summary(outcome_model))

# or 5: Poisson Regression with Robust Standard Errors for convergence issues
outcome_model <- glm(PCL_bi ~ sum_wipe + sum_air + ASI_s, 
                     family = poisson, data = df)
coeftest(outcome_model, vcov = sandwich)

# Run mediation analysis with bootstrapping: for non-normal mediator
mediation_result <- mediate(mediator_model, outcome_model, 
                            treat = c("sum_wipe", "sum_air"), mediator = "ASI_s",
                            boot = TRUE, sims = 5000)  # Increase sims for stability

# Print results
summary(mediation_result)
```

new version (still problematic)
```{r}
# convert PCL_bi to numeric
df$PCL_bi <- as.numeric(as.character(df$PCL_bi))

# Fit mediator model (Linear Regression)
mediator_model <- lm(ASI_s ~ sum_wipe + sum_air, data = df)

# or 5: Poisson Regression with Robust Standard Errors for convergence issues
outcome_model <- glm(PCL_bi ~ sum_wipe + sum_air + ASI_s, 
                     family = poisson, data = df)
# coeftest(outcome_model, vcov = sandwich)

# Run mediation analysis with bootstrapping: for non-normal mediator
mediation_result <- mediate(mediator_model, outcome_model, 
                            treat = c("sum_wipe", "sum_air"), mediator = "ASI_s",
                            boot = TRUE, sims = 5000)  # Increase sims for stability

# Print results
summary(mediation_result)
```

(problematic)

mediator: sqrt(ASI_s)
exposure: sum_air 
outcome: PCL_bi (binary variable)
```{r}
# create a column for sqrt(ASI_s)
df$sqrt_ASI_s <- sqrt(df$ASI_s)

# Fit mediator model (Linear Regression)
mediator_model <- lm(sqrt_ASI_s ~ sum_air, data = df)

# Fit outcome model (Log-binomial Model for PCL_bi)
outcome_model <- glm(PCL_bi ~ sum_air + sqrt_ASI_s, 
                     data = df, 
                     family = poisson(link = "log"))

summary(outcome_model)

# Run mediation analysis with bootstrapping
mediation_result <- mediate(mediator_model, outcome_model, 
                            treat = "sum_air", mediator = "sqrt_ASI_s",
                            boot = TRUE, sims = 5000)  # Increase sims for stability

# Print results
summary(mediation_result)
```

### mediator: ASI_bi (binary variable ) exposure: sum_wipe
outcome: PCL_bi
```{r}
mediator_model <- glm(ASI_bi ~ sum_wipe, family = binomial(link = "logit"), data = df)

outcome_model <- glm(PCL_bi ~ sum_wipe + ASI_bi, family = binomial(link = "logit"), data = df)

# Mediation Analysis
mediation_result <- mediate(mediator_model, outcome_model,
                            treat = "sum_wipe", mediator = "ASI_bi",
                            boot = TRUE, sims = 5000)  # Bootstrapping for CI

# Print results
summary(mediation_result)

outcome_model_interaction <- glm(PCL_bi ~ sum_wipe * ASI_s_bi, family = binomial(link = "logit"), data = df)

```



### mediator: sqrt(ASI) exposure: sum_air + sum_wipe
outcome: PCL_bi (binary variable)
```{r}

```


### mediator: sqrt(ASI_s) exposure: sum_air + sum_wipe
outcome: PCL_bi (binary variable)
```{r}

```


### mediator: traumaonduty exposure: sum_air
traumaonduty includes:
"Fire.related.incidents"                     
"Natural.disasters"                          
"Sudden.death.or.loss.of.a.peer.firefighters"
"Serious.accidents.or.injuries"              
"Serious.illness.or.medical.procedures"
I discard the "Covid" and "Vehicle.Accidents" bc they only have one 1.
outcome: PCL
```{r}
library(logistf)  # Firth logistic regression in case of separation

# STEP 1: Fit mediator models (Logistic regression)
mediator_models <- list()
trauma_vars <- c("Fire.related.incidents", "Natural.disasters", 
                 "Sudden.death.or.loss.of.a.peer.firefighters",
                 "Serious.accidents.or.injuries", "Serious.illness.or.medical.procedures")

for (trauma in trauma_vars) {
  mediator_models[[trauma]] <- glm(as.formula(paste(trauma, "~ sum_air")), 
                                   family = binomial, data = df)
}

# STEP 2: outcome Model:
library(MASS)  # For Negative Binomial regression

# Check for overdispersion first
poisson_model <- glm(PCL ~ sum_air + Fire.related.incidents + Natural.disasters + 
                     Sudden.death.or.loss.of.a.peer.firefighters + 
                     Serious.accidents.or.injuries + Serious.illness.or.medical.procedures, 
                     family = poisson, data = df)

# Compute mean and variance of PCL
mean_pcl <- mean(df$PCL)
var_pcl <- var(df$PCL)

if (var_pcl > mean_pcl) {
  # If variance > mean, use Negative Binomial
  outcome_model <- glm.nb(PCL ~ sum_air + Fire.related.incidents + Natural.disasters + 
                          Sudden.death.or.loss.of.a.peer.firefighters + 
                          Serious.accidents.or.injuries + Serious.illness.or.medical.procedures, 
                          data = df)
} else {
  # Otherwise, use Poisson
  outcome_model <- poisson_model
}

# STEP 3: Mediation Analysis
mediation_results <- list()

for (trauma in trauma_vars) {
  mediation_results[[trauma]] <- mediate(mediator_models[[trauma]], outcome_model,
                                         treat = "sum_air", mediator = trauma,
                                         boot = TRUE, sims = 5000)
}

# Print results for each mediator
for (trauma in trauma_vars) {
  print(trauma)
  print(summary(mediation_results[[trauma]]))
}
```
Fix the model:
```{r}
# Step 1: Check how many cases exist for each trauma type when PCL_bi == 0 or 1
sapply(df[which(df$PCL_bi==1), c("Fire.related.incidents", "Natural.disasters", 
              "Sudden.death.or.loss.of.a.peer.firefighters",
              "Serious.accidents.or.injuries", "Serious.illness.or.medical.procedures")], table)

# step 2: Change the Mediator Model: Use Separate Logistic Regressions
table(df$Fire.related.incidents, df$PCL_bi)
table(df$Natural.disasters, df$PCL_bi)
table(df$Sudden.death.or.loss.of.a.peer.firefighters, df$PCL_bi)

library(logistf)  # In case of separation

# Trauma types
trauma_vars <- c("Fire.related.incidents", "Natural.disasters", 
                 "Sudden.death.or.loss.of.a.peer.firefighters",
                 "Serious.accidents.or.injuries", "Serious.illness.or.medical.procedures")

# Fit logistic regression for each trauma type as a separate mediator
mediator_models <- list()
library(brms)
for (trauma in trauma_vars) {
  mediator_models[[trauma]] <- brm(as.formula(paste(trauma, "~ sum_air")), 
                                   family = bernoulli(), data = df)
}

# Step 3: Change the Outcome Model: Use Negative Binomial Regression: Since PCL is a count variable, we need to check for overdispersion:
library(MASS)

# Check overdispersion
mean_pcl <- mean(df$PCL, na.rm = TRUE)
var_pcl <- var(df$PCL, na.rm = TRUE)

if (var_pcl > mean_pcl) {
  # Use Negative Binomial if variance > mean
  outcome_model <- glm.nb(PCL ~ sum_air + Fire.related.incidents + Natural.disasters + 
                          Sudden.death.or.loss.of.a.peer.firefighters + 
                          Serious.accidents.or.injuries + Serious.illness.or.medical.procedures, 
                          data = df)
} else {
  # Use Poisson if variance ≈ mean
  outcome_model <- glm(PCL ~ sum_air + Fire.related.incidents + Natural.disasters + 
                       Sudden.death.or.loss.of.a.peer.firefighters + 
                       Serious.accidents.or.injuries + Serious.illness.or.medical.procedures, 
                       family = poisson, data = df)
}
summary(outcome_model)

library(mediation)

mediation_results <- list()
for (trauma in trauma_vars) {
  mediation_results[[trauma]] <- mediate(mediator_models[[trauma]], outcome_model,
                                         treat = "sum_air", mediator = trauma,
                                         boot = TRUE, sims = 5000)
}

```


### mediator: traumachildhood; exposure: sum_air
"Physical.or.emotional.abuse"                
"Neglect.or.abandonment"                     
"Witnessing.domestic.violence"               
"Natural.disasters.1"                        
"Sudden.death.or.loss.of.a.loved.one"        
"Serious.accidents.or.injuries.1"            
"Forced.displacement.or.migration"           
"Serious.illness.or.medical.procedures.1"    
"Bullying.or.peer.victimization"             
"Parents.fighting"    


### mediator: FH_mentalhealth
"FH_PTSD"                                    
"FH_DEPRESSION"                              
"FH_ANXIETY"                                 
"FH_STRESS"                                  
"FH_DEMENTIA"                                
"FH_Alzheimer.s"                             
"FH_bipolar"  

### mediator: Years.as.a.Firefighter

### mediator: Avg.fire.related.activities.per.week

### mediator: Avg.hrs.on.fire.scenes.per.week

# bar plot of frequency of CESD_bi
```{r}
freq_CESD <- table(quest$CESD_bi)
barplot(freq_CESD, main = "Distribution of CESD", xlab = "Depression", ylab = "frequency", col = c("skyblue", "orange"))
print(paste("proportion of 1s:", round(mean(quest$CESD_bi),2)))

```

